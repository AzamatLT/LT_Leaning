

--

WAL

1. Что такое WAL?
WAL (Write-Ahead Logging) — это журнал предзаписи, в который PostgreSQL записывает все изменения данных (например, вставки, обновления, удаления) перед тем, как они будут применены к основным таблицам на диске. Это обеспечивает:

Надёжность: данные не теряются даже в случае сбоя (например, отключения питания).

Восстановление: WAL позволяет восстановить данные до последнего согласованного состояния после сбоя.

Репликацию: WAL используется для потоковой репликации (streaming replication) между серверами.

2. Что такое WAL archive?
WAL archive — это процесс архивирования файлов WAL (сегментов журнала) в отдельное хранилище (например, на другой диск или в облако). Эти файлы содержат последовательность изменений, которые произошли в базе данных.

3. Для чего нужен WAL archive?
a) Point-in-Time Recovery (PITR)
WAL archive позволяет восстановить базу данных на любой момент времени в прошлом (Point-in-Time Recovery). Это полезно, если:

Произошла ошибка (например, удаление данных).

Необходимо восстановить данные до определённого момента (например, до сбоя или ошибочной операции).

Для этого используются:

Базовые резервные копии (base backup), созданные с помощью pg_basebackup.

Архивированные WAL-файлы, которые содержат изменения, произошедшие после создания базовой резервной копии.

b) Репликация
WAL archive используется для настройки репликации:

Streaming replication: WAL-файлы передаются на реплику в реальном времени.

Логическая репликация: WAL-файлы используются для передачи изменений на логическом уровне.

c) Долгосрочное хранение изменений
WAL-файлы можно архивировать на длительный срок для:

Аудита изменений.

Анализа данных.

Восстановления данных на определённый момент времени.

d) Резервное копирование
WAL archive является частью стратегии резервного копирования. В сочетании с базовыми резервными копиями он позволяет создавать полные и инкрементальные резервные копии.

4. Как работает WAL archive?
PostgreSQL записывает изменения в WAL-файлы (сегменты журнала).

Когда WAL-файл заполняется, он архивируется с помощью команды, указанной в параметре archive_command (например, копирование в облако или на другой диск).

Архивированные WAL-файлы хранятся в отдельном месте, указанном в конфигурации.

При необходимости восстановления PostgreSQL использует базовую резервную копию и применяет архивированные WAL-файлы для восстановления данных до нужного момента.


--

AUDIT

pgAudit — это расширение PostgreSQL для детализированного аудита. В pgAudit хранится информация о действиях пользователей и операциях в базе данных. Коротко о том, что записывается:

SQL-запросы:

Тип операции (SELECT, INSERT, UPDATE, DELETE, DDL и т.д.).

Текст запроса.

Контекст выполнения:

Имя пользователя, выполнившего запрос.

Имя базы данных.

Имя приложения (если указано).

Объекты базы данных:

Таблицы, к которым был выполнен доступ.

Столбцы, если это указано в настройках.

Результат операции:

Успешное выполнение или ошибка.

Временные метки:

Время выполнения запроса.

Пример записи в pgAudit:
Copy
AUDIT: SESSION,1,1,READ,SELECT,,,SELECT * FROM users;,<none>
SESSION: тип аудита (сессия или объект).

1,1: идентификаторы сессии и команды.

READ: тип операции (чтение).

SELECT: тип SQL-запроса.

SELECT * FROM users;: текст запроса.

Для чего это нужно:
Отслеживание действий пользователей.

Анализ безопасности.

Соответствие нормативным требованиям (GDPR, PCI DSS и др.).

Важно:
pgAudit не хранит данные в отдельной таблице, а записывает их в стандартные логи PostgreSQL.

Для анализа логов могут потребоваться дополнительные инструменты (например, ELK Stack).


--


Термины связанные с производительностью дисков БД

1. Общие термины производительности дисков
IOPS (Input/Output Operations Per Second) — количество операций ввода-вывода, которые диск может выполнить за секунду. Важный показатель для оценки производительности диска.

Throughput (пропускная способность) — объём данных, который может быть передан через диск за единицу времени (обычно измеряется в МБ/с или ГБ/с).

Latency (задержка) — время, которое требуется для выполнения одной операции ввода-вывода. Измеряется в миллисекундах (мс).

Seek time (время поиска) — время, необходимое диску для перемещения головки чтения/записи к нужному месту на диске.

Queue depth (глубина очереди) — количество операций ввода-вывода, ожидающих выполнения на диске. Высокая глубина очереди может указывать на перегрузку диска.

Utilization (использование) — процент времени, в течение которого диск был занят выполнением операций ввода-вывода. Высокий уровень использования (близкий к 100%) может указывать на перегрузку.

2. Термины, связанные с кэшированием
Cache hit ratio (коэффициент попадания в кэш) — процент операций чтения, которые были выполнены из кэша, а не с диска. Высокий коэффициент указывает на эффективное использование кэша.

Cache miss (промах кэша) — ситуация, когда данные не найдены в кэше и требуется чтение с диска.

Write-back cache — метод кэширования, при котором данные сначала записываются в кэш, а затем асинхронно на диск.

Write-through cache — метод кэширования, при котором данные записываются одновременно в кэш и на диск.

3. Термины, связанные с RAID
RAID 0, RAID 1, RAID 5, RAID 10 — различные уровни RAID, которые влияют на производительность и отказоустойчивость дисков.

Striping (чередование) — метод распределения данных по нескольким дискам для повышения производительности (используется в RAID 0 и RAID 5).

Mirroring (зеркалирование) — метод дублирования данных на нескольких дисках для повышения отказоустойчивости (используется в RAID 1).

Parity (чётность) — метод восстановления данных в случае сбоя диска (используется в RAID 5 и RAID 6).

4. Термины, связанные с файловыми системами
Fragmentation (фрагментация) — ситуация, когда файлы разбиты на фрагменты и разбросаны по диску, что может снижать производительность.

Inode — структура данных в файловых системах (например, ext4), которая хранит метаданные о файле.

Journaling (журналирование) — метод, при котором изменения в файловой системе сначала записываются в журнал, что повышает надёжность и скорость восстановления после сбоев.

5. Термины, связанные с SSD
Wear leveling (выравнивание износа) — технология, используемая в SSD для равномерного распределения операций записи по ячейкам памяти, чтобы продлить срок службы диска.

TRIM — команда, которая позволяет операционной системе сообщать SSD, какие блоки данных больше не используются, что помогает поддерживать производительность.

NAND flash — тип памяти, используемый в SSD. Включает SLC, MLC, TLC и QLC, которые отличаются по скорости и долговечности.

6. Термины, связанные с мониторингом и анализом
Disk queue length — количество запросов ввода-вывода, ожидающих обработки на диске. Высокое значение может указывать на перегрузку.

Read/Write ratio — соотношение операций чтения и записи. Помогает понять нагрузку на диск.

Average wait time (среднее время ожидания) — среднее время, которое запросы проводят в очереди перед выполнением.

Disk bandwidth — пропускная способность диска, измеряемая в МБ/с или ГБ/с.

7. Термины, связанные с базами данных
Checkpoint — процесс записи изменённых данных из оперативной памяти на диск. Частота контрольных точек влияет на производительность.

WAL (Write-Ahead Logging) — журнал предзаписи, используемый в PostgreSQL для обеспечения надёжности и восстановления данных.

Vacuum — процесс очистки в PostgreSQL, который освобождает место, занимаемое удалёнными или устаревшими данными.

Autovacuum — автоматический процесс очистки в PostgreSQL, который помогает поддерживать производительность.

